#This script computes perâ€‘feature zonal means of the normalised TBDeff rasters (3, 7, 19, 37 GHz) 
#for each transect/ROI shapefile. For every shapefile in valid_transects, 
#it outputs a CSV file containing the mean TBDeff values per zone. 
#These aggregated values are used to populate Table 1 and to generate the ROI plots in Figure 2 
#(see Section 3.8 of the manuscript).

#ANNOTATED CODE EXCERPT

# --- User parameters: edit these paths and names ---
arcpy.env.workspace = r"F:\ArcProjects\Tranquillitatis"
arcpy.env.overwriteOutput = True

# Ensure Spatial Analyst is available
arcpy.CheckOutExtension("Spatial")

# Normalised rasters (full paths)
rasters = [
    r"F:\ArcProjects\Tranquillitatis\TBDeff_3_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_7_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_19_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_37_norm.tif"
]

# Labels for output columns
raster_labels = {
    rasters[0]: "Mean_3GHz",
    rasters[1]: "Mean_7GHz",
    rasters[2]: "Mean_19GHz",
    rasters[3]: "Mean_37GHz"
}

# List of transect shapefiles (ROIs)
valid_transects = [
    r"transect_A.shp",
    r"transect_B.shp",
    r"transect_C.shp",
    r"transect_D.shp",
    r"transect_O.shp"
]

# Output folder for zonal stats CSVs
out_folder = os.path.join(arcpy.env.workspace, "ZonalStats")
os.makedirs(out_folder, exist_ok=True)

# Zone field in shapefiles (feature ID)
zone_field = "FID"

#RAW SCRIPT

import arcpy
import os
import csv

# --- User parameters: edit these paths and names ---
arcpy.env.workspace = r"F:\ArcProjects\Tranquillitatis"
arcpy.env.overwriteOutput = True

# Ensure Spatial Analyst is available
arcpy.CheckOutExtension("Spatial")

# Normalised rasters (full paths)
rasters = [
    r"F:\ArcProjects\Tranquillitatis\TBDeff_3_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_7_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_19_norm.tif",
    r"F:\ArcProjects\Tranquillitatis\TBDeff_37_norm.tif"
]

# Labels for output columns (use raster path as key)
raster_labels = {
    rasters[0]: "Mean_3GHz",
    rasters[1]: "Mean_7GHz",
    rasters[2]: "Mean_19GHz",
    rasters[3]: "Mean_37GHz"
}

# List of transect shapefiles (relative to workspace or absolute)
valid_transects = [
    r"transect_A.shp",
    r"transect_B.shp",
    r"transect_C.shp",
    r"transect_D.shp",
    r"transect_O.shp"
]

# Output folder for zonal stats CSVs
out_folder = os.path.join(arcpy.env.workspace, "ZonalStats")
os.makedirs(out_folder, exist_ok=True)

# Zone field in shapefiles (change to OBJECTID or your ID field if needed)
zone_field = "FID"

for shp in valid_transects:
    shp_path = shp if os.path.isabs(shp) else os.path.join(arcpy.env.workspace, shp)
    if not arcpy.Exists(shp_path):
        print(f"Skipping {shp}, file not found")
        continue

    # Skip empty shapefiles
    count = int(arcpy.GetCount_management(shp_path).getOutput(0))
    if count == 0:
        print(f"Skipping {shp}, no features")
        continue

    shp_name = os.path.splitext(os.path.basename(shp_path))[0]
    print(f"Processing shapefile: {shp_name}")

    # Dictionary: {zone_value: {Mean_3GHz: val, ...}}
    merged = {}

    for raster in rasters:
        label = raster_labels[raster]
        print(f"  Zonal stats for raster: {label}")

        out_table = os.path.join("in_memory", f"{shp_name}_{label}_stats")
        try:
            arcpy.sa.ZonalStatisticsAsTable(in_zone_data=shp_path,
                                            zone_field=zone_field,
                                            in_value_raster=raster,
                                            out_table=out_table,
                                            ignore_nodata="DATA",
                                            statistics_type="MEAN")
        except Exception as e:
            print(f"    ZonalStatisticsAsTable failed for {label}: {e}")
            continue

        # Check if table has rows
        row_count = int(arcpy.GetCount_management(out_table).getOutput(0))
        if row_count == 0:
            print(f"    No overlap with raster, skipping {label}")
            arcpy.Delete_management(out_table)
            continue

        # Find the MEAN field name in the output table (robust to naming)
        mean_field = None
        for f in arcpy.ListFields(out_table):
            if f.name.upper().startswith("MEAN"):
                mean_field = f.name
                break
        if mean_field is None:
            print(f"    Could not find MEAN field in {out_table}, skipping")
            arcpy.Delete_management(out_table)
            continue

        # Read results: zone value and mean
        with arcpy.da.SearchCursor(out_table, [zone_field, mean_field]) as cursor:
            for zone_val, mean_val in cursor:
                if zone_val not in merged:
                    merged[zone_val] = {}
                merged[zone_val][label] = mean_val

        arcpy.Delete_management(out_table)

    # Write consolidated CSV for this shapefile
    csv_path = os.path.join(out_folder, f"{shp_name}_zonal_means.csv")
    print(f"  Writing consolidated CSV: {csv_path}")

    header = [zone_field] + [raster_labels[r] for r in rasters]
    fids_sorted = sorted(merged.keys())

    with open(csv_path, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(header)
        for fid in fids_sorted:
            row = [fid]
            for r in rasters:
                label = raster_labels[r]
                row.append(merged[fid].get(label, None))
            writer.writerow(row)

print("Done.")